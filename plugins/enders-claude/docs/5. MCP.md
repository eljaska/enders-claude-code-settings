# 5. MCP - Model Context Protocol

## Overview

MCP (Model Context Protocol) is an open standard protocol for connecting Claude Code to external tools, APIs, databases, and services. It enables Claude to query databases, fetch documentation, monitor errors, automate browsers, and integrate with your entire development toolchain.

**Think of it as**: A plugin system for Claude - connecting it to external services it couldn't otherwise access.

**Key characteristics**:
- Open standard protocol
- Three transport types (HTTP, Stdio, SSE)
- Provides tools (actions) and resources (data)
- Scoped configuration (local, project, user)
- OAuth authentication support
- Extensible via custom servers

## Key Concepts

### MCP Components

**MCP Server**: External service that exposes tools and resources
**MCP Client**: Claude Code (connects to servers)
**Tools**: Actions Claude can perform (e.g., query database, create ticket)
**Resources**: Data Claude can reference (e.g., GitHub issues, documentation)

### Transport Types

| Transport | Description | Use Case | Status |
|-----------|-------------|----------|--------|
| **HTTP** | HTTP/HTTPS connections | Remote services, managed servers | Recommended |
| **Stdio** | Local process via stdin/stdout | Local tools, CLI wrappers | Supported |
| **SSE** | Server-Sent Events | Streaming connections | Deprecated |

### Configuration Scopes

| Scope | File | Use Case | Committed? | Priority |
|-------|------|----------|------------|----------|
| **Local** | `~/.claude.json` | Personal experiments | No | Highest |
| **Project** | `.mcp.json` | Team-shared tools | Yes | Medium |
| **User** | `~/.claude.json` | Personal utilities | No | Lowest |

**Priority**: Local > Project > User (local overrides all)

## How It Works

### Connection Flow

```
Claude Code starts
  ↓
Reads MCP configurations (.mcp.json, ~/.claude.json)
  ↓
Connects to MCP servers
  ↓
Discovers tools and resources from each server
  ↓
Makes tools available to Claude
  ↓
User asks question requiring external data
  ↓
Claude invokes MCP tool
  ↓
MCP server processes request
  ↓
Returns data to Claude
  ↓
Claude uses data in response
```

### Tool Invocation

When Claude needs external data:
```
User: "How many active users do we have?"
  ↓
Claude: Identifies need for database query
  ↓
Claude: Invokes MCP database tool
  ↓
Database MCP: Executes SELECT query
  ↓
Database MCP: Returns results
  ↓
Claude: Formats and presents data
```

### Resource Access

Resources can be referenced with `@` mentions:
```
User: Can you analyze @github:issue://123?
  ↓
Claude: Fetches issue #123 via GitHub MCP
  ↓
Claude: Analyzes issue content
```

## Configuration

### Command-Line Setup

#### HTTP Server (Recommended)

```bash
claude mcp add --transport http github https://api.githubcopilot.com/mcp/
```

#### Stdio Server (Local Tools)

```bash
claude mcp add --transport stdio --env API_KEY=secret postgres -- npx -y @bytebase/dbhub --dsn "postgresql://user:pass@localhost:5432/db"
```

#### Scope Selection

```bash
# Project scope (shared with team)
claude mcp add --scope project --transport http github https://api.github.com/mcp

# User scope (all your projects)
claude mcp add --scope user --transport http context7 https://api.context7.com/mcp

# Local scope (personal experiments) - default
claude mcp add --transport stdio test-tool -- node test-tool.js
```

### File Configuration

#### Project .mcp.json

**File**: `.mcp.json` (project root)

```json
{
  "mcpServers": {
    "github": {
      "transport": "http",
      "url": "https://api.githubcopilot.com/mcp/"
    },
    "postgres": {
      "transport": "stdio",
      "command": "npx",
      "args": ["-y", "@bytebase/dbhub", "--dsn", "${DB_URL}"],
      "env": {
        "DB_URL": "postgresql://readonly:${DB_PASSWORD}@prod.db.com:5432/analytics"
      }
    }
  }
}
```

**Commit to git**: Yes, so team benefits

#### User ~/.claude.json

**File**: `~/.claude.json`

```json
{
  "mcpServers": {
    "context7": {
      "transport": "http",
      "url": "https://api.context7.com/mcp"
    },
    "personal-db": {
      "transport": "stdio",
      "command": "npx",
      "args": ["-y", "@bytebase/dbhub", "--dsn", "${PERSONAL_DB_URL}"]
    }
  }
}
```

### Management Commands

```bash
# List all configured servers
claude mcp list

# Get details for specific server
claude mcp get github

# Remove a server
claude mcp remove github

# Authenticate (for OAuth servers)
/mcp  # In Claude session
```

## Usage Patterns

### Basic Usage

#### Example 1: Query Database

**Setup**:
```bash
claude mcp add --transport stdio --scope project \
  --env DB_URL="postgresql://readonly:${DB_PASSWORD}@prod.db.com:5432/analytics" \
  prod-db -- npx -y @bytebase/dbhub --dsn "${DB_URL}"
```

**Usage**:
```
User: How many users signed up this month?
Claude: [Invokes prod-db MCP tool]
Claude: There were 1,234 new user signups this month.
```

#### Example 2: Fetch Documentation

**Setup**:
```bash
claude mcp add --transport http context7 https://api.context7.com/mcp
```

**Usage**:
```
User: How do I use React useState hook?
Claude: [Queries context7 for React docs]
Claude: The useState hook allows you to add state to functional components...
```

#### Example 3: Monitor Errors

**Setup**:
```bash
claude mcp add --transport http sentry https://mcp.sentry.dev/mcp
```

**Usage**:
```
User: What errors occurred in the last hour?
Claude: [Queries Sentry MCP]
Claude: Found 3 errors:
1. TypeError in user-service.ts:45 (12 occurrences)
2. DatabaseConnectionError (3 occurrences)
3. ValidationError in api.ts:123 (1 occurrence)
```

#### Example 4: GitHub Integration

**Setup**:
```bash
claude mcp add --transport http --scope project github https://api.githubcopilot.com/mcp/
```

**Usage**:
```
User: What issues are assigned to me?
Claude: [Queries GitHub MCP]
Claude: You have 5 open issues:
1. #456: Fix authentication bug
2. #457: Add user profile page
...

User: Create an issue for the bug we just found
Claude: [Creates issue via GitHub MCP]
Claude: Created issue #458: "SQL injection in login endpoint"
```

### Advanced Usage

#### Example 5: Access Resources with @ Mentions

```
User: Compare @github:issue://123 with @github:pr://456
Claude: [Fetches both via GitHub MCP]
Claude: Issue #123 and PR #456 both address authentication...

User: Analyze the error in @sentry:error://abc123
Claude: [Fetches error via Sentry MCP]
Claude: This error occurs when users submit empty forms...
```

#### Example 6: Environment Variable Expansion

**.mcp.json**:
```json
{
  "mcpServers": {
    "database": {
      "transport": "stdio",
      "command": "npx",
      "args": ["-y", "@bytebase/dbhub", "--dsn", "${DB_URL:-postgresql://localhost:5432/dev}"],
      "env": {
        "DB_USER": "${DB_USER}",
        "DB_PASSWORD": "${DB_PASSWORD}"
      }
    }
  }
}
```

**Usage**: References `$DB_URL`, `$DB_USER`, `$DB_PASSWORD` from environment

#### Example 7: Multiple Database Connections

```json
{
  "mcpServers": {
    "prod-db": {
      "transport": "stdio",
      "command": "npx",
      "args": ["-y", "@bytebase/dbhub", "--dsn", "${PROD_DB_URL}"]
    },
    "analytics-db": {
      "transport": "stdio",
      "command": "npx",
      "args": ["-y", "@bytebase/dbhub", "--dsn", "${ANALYTICS_DB_URL}"]
    },
    "dev-db": {
      "transport": "stdio",
      "command": "npx",
      "args": ["-y", "@bytebase/dbhub", "--dsn", "postgresql://localhost:5432/dev"]
    }
  }
}
```

**Usage**:
```
User: Compare user counts between prod and analytics databases
Claude: [Queries both prod-db and analytics-db]
Claude: Production DB has 10,234 users, Analytics DB shows 10,198 (36 difference)
```

## Examples

### Complete MCP Configurations

#### Example: Full-Stack Project

**.mcp.json**:
```json
{
  "mcpServers": {
    "github": {
      "transport": "http",
      "url": "https://api.githubcopilot.com/mcp/"
    },
    "postgres": {
      "transport": "stdio",
      "command": "npx",
      "args": ["-y", "@bytebase/dbhub", "--dsn", "${DB_URL}"],
      "env": {
        "DB_URL": "postgresql://readonly:${DB_PASSWORD}@prod.db.com:5432/app"
      }
    },
    "sentry": {
      "transport": "http",
      "url": "https://mcp.sentry.dev/mcp"
    },
    "context7": {
      "transport": "http",
      "url": "https://api.context7.com/mcp"
    }
  }
}
```

**Environment** (`.env.local`, not committed):
```bash
DB_PASSWORD=secure_password_here
```

## Common MCP Servers

| Server | Use Case | Transport | Install Command |
|--------|----------|-----------|-----------------|
| **context7** | Live documentation for libraries | HTTP | `claude mcp add context7` |
| **GitHub** | Issues, PRs, actions | HTTP | `claude mcp add github` |
| **Playwright** | Browser automation/testing | Stdio | `claude mcp add playwright -- npx -y @playwright/mcp` |
| **Supabase** | Database operations | HTTP | `claude mcp add supabase` |
| **Database** | PostgreSQL/MySQL queries | Stdio | See database setup |
| **Sentry** | Error monitoring | HTTP | `claude mcp add sentry` |
| **Linear** | Issue management | HTTP | `claude mcp add linear` |
| **Slack** | Team messaging | Stdio | `claude mcp add slack -- npx -y @slack/mcp` |
| **AWS** | Cloud resource management | Stdio | `claude mcp add aws -- npx -y @aws/mcp` |
| **Docker** | Container management | Stdio | `claude mcp add docker -- npx -y @docker/mcp` |

## Best Practices

### Security

1. **Use read-only credentials for databases**:
   ```bash
   # Create read-only user
   CREATE USER readonly WITH PASSWORD 'secure_pass';
   GRANT CONNECT ON DATABASE analytics TO readonly;
   GRANT SELECT ON ALL TABLES IN SCHEMA public TO readonly;
   ```

2. **Never commit secrets**:
   ```json
   // Bad
   {"DB_PASSWORD": "my_password"}

   // Good
   {"DB_PASSWORD": "${DB_PASSWORD}"}
   ```

3. **Use environment variables**:
   ```bash
   export DB_PASSWORD="secure_password"
   claude
   ```

4. **Verify MCP server source**:
   - Only install trusted MCP servers
   - Check server source code when possible
   - Be cautious with third-party servers

5. **Review OAuth scopes**:
   - Only grant necessary permissions
   - Review scopes in `/mcp` authentication dialog

### Configuration

1. **Use project scope for team tools**:
   ```bash
   claude mcp add --scope project github https://...
   ```

2. **Commit .mcp.json to version control**:
   ```bash
   git add .mcp.json
   git commit -m "Add MCP server configurations"
   ```

3. **Document required environment variables**:
   ```markdown
   # README.md
   ## Required Environment Variables
   - `DB_URL`: PostgreSQL connection string
   - `SENTRY_TOKEN`: Sentry API token
   ```

4. **Use HTTP transport when possible**:
   - More reliable than Stdio
   - Better error handling
   - Managed by server provider

5. **Handle missing environment variables**:
   ```json
   {
     "args": ["--dsn", "${DB_URL:-postgresql://localhost:5432/dev}"]
   }
   ```

### Performance

1. **Monitor output limits**:
   - MCP warns when output exceeds 10,000 tokens
   - Use LIMIT clauses in database queries
   - Paginate large results

2. **Enable Tool Search for many servers**:
   ```bash
   export ENABLE_TOOL_SEARCH=auto
   ```
   Recommended when you have 10+ MCP servers

3. **Cache frequently accessed data**:
   - Some MCP servers support caching
   - Reduce API calls
   - Improve response times

## Common Patterns

### Pattern 1: Database Read-Only Access

```json
{
  "mcpServers": {
    "analytics": {
      "transport": "stdio",
      "command": "npx",
      "args": ["-y", "@bytebase/dbhub", "--dsn", "${ANALYTICS_DB_URL}"],
      "env": {
        "ANALYTICS_DB_URL": "postgresql://readonly:${DB_PASSWORD}@analytics.db.com:5432/analytics"
      }
    }
  }
}
```

### Pattern 2: Multi-Service Integration

```json
{
  "mcpServers": {
    "github": {"transport": "http", "url": "https://..."},
    "sentry": {"transport": "http", "url": "https://..."},
    "database": {"transport": "stdio", "command": "...", "args": [...]}
  }
}
```

### Pattern 3: Development vs. Production

```json
{
  "mcpServers": {
    "database": {
      "transport": "stdio",
      "command": "npx",
      "args": ["-y", "@bytebase/dbhub", "--dsn", "${DB_URL:-postgresql://localhost:5432/dev}"]
    }
  }
}
```

Set `DB_URL` in production, defaults to localhost in dev.

## Gotchas and Troubleshooting

### Common Issues

#### Issue 1: MCP Server Not Connecting

**Symptoms**: Server listed but tools unavailable

**Causes**:
- Authentication required
- Server URL incorrect
- Network issues

**Solutions**:
```bash
# Authenticate
/mcp  # In Claude session

# Verify configuration
claude mcp get server-name

# Check server status
claude mcp list
```

#### Issue 2: Environment Variables Not Expanding

**Symptoms**: Literal `${VAR}` in configuration

**Cause**: Variable not set in environment

**Solution**:
```bash
export DB_URL="postgresql://..."
claude
```

#### Issue 3: Stdio Server Fails

**Symptoms**: Server crashes or doesn't respond

**Causes**:
- Command not found
- Missing dependencies
- Incorrect arguments

**Solutions**:
```bash
# Test command manually
npx -y @bytebase/dbhub --dsn "postgresql://..."

# Install dependencies
npm install -g @bytebase/dbhub

# Check logs
claude --mcp-debug
```

#### Issue 4: Permission Denied

**Symptoms**: MCP tools fail with permission errors

**Cause**: Tool permissions not configured

**Solution**: Configure in `.claude/settings.json`:
```json
{
  "permissions": {
    "allow": ["mcp__database__*", "mcp__github__*"]
  }
}
```

#### Issue 5: Project Scope Requires Approval

**Symptoms**: Prompt to approve project-scoped servers

**Cause**: First use of project `.mcp.json`

**Solution**: Review and approve in session (one-time)

### Debugging

**Enable MCP debugging**:
```bash
claude --mcp-debug
```

**Check server status**:
```bash
claude mcp list
claude mcp get server-name
```

**Test manually**:
```bash
# For stdio servers
npx -y @bytebase/dbhub --dsn "postgresql://..."
```

### Limitations

1. **SSE transport deprecated**: Use HTTP instead
2. **Windows needs cmd /c wrapper**: Wrap npx in `cmd /c`
3. **Tool Search requires newer models**: Haiku models don't support
4. **10,000 token output limit**: Large results truncated
5. **Project scope needs approval**: First-time user confirmation required

## API Reference

### .mcp.json Schema

```json
{
  "mcpServers": {
    "server-name": {
      "transport": "http" | "stdio" | "sse",
      "url": "string (HTTP only)",
      "command": "string (Stdio only)",
      "args": ["array", "of", "strings"] (Stdio only),
      "env": {
        "KEY": "value"
      }
    }
  }
}
```

### Field Descriptions

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `transport` | string | Yes | "http", "stdio", or "sse" |
| `url` | string | HTTP only | Server URL |
| `command` | string | Stdio only | Command to execute |
| `args` | array | Stdio only | Command arguments |
| `env` | object | No | Environment variables |

### CLI Commands

| Command | Description |
|---------|-------------|
| `claude mcp add <name>` | Add MCP server |
| `claude mcp list` | List all servers |
| `claude mcp get <name>` | Get server details |
| `claude mcp remove <name>` | Remove server |
| `/mcp` | Authenticate in session |

### Resource Syntax

Access MCP resources with @ mentions:

```
@server:resource-type://identifier

Examples:
@github:issue://123
@github:pr://456
@sentry:error://abc123def
@database:table://users
```

## Related Features

### Skills
Skills can use MCP tools via Bash. MCP provides external data, Skills provide workflows.

### Subagents
Subagents can access MCP tools. MCP extends their capabilities beyond code.

### Hooks
Hooks can't directly use MCP, but can prepare data for MCP queries.

## Additional Resources

- **MCP Protocol**: https://modelcontextprotocol.io
- **Official Documentation**: https://docs.anthropic.com/claude/docs/mcp
- **MCP Server Registry**: https://github.com/modelcontextprotocol/servers
- **Community Servers**: https://github.com/topics/mcp-server

---

**Next**: Learn about [Checkpoints](./6.%20Checkpoints.md) for session-level version control.
